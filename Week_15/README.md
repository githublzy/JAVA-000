# 秒杀系统的设计

# 1.什么是秒杀系统

通俗一点讲就是网络商家为促销等目的组织的网上限时抢购活动

比如说京东秒杀，就是一种定时定量秒杀，在规定时间内，无论商品是否秒杀完毕，该场次的秒杀活动都会结束。这种秒杀，对时间不是特别严格，只要是下手快，秒中的概率就比较大。

# 2.秒杀系统的业务特点

## 瞬时并发量大

秒杀时会有大量用户在同一时间进行抢购，瞬时并发访问量很大。

## 库存量少

一般秒杀活动的商品量很少，这就导致了只有极少数的用户可以成功购买到商品。

## 业务简单

流程比较简单，一般都是下订单、扣库存、支付订单。

# 3.秒杀应该考虑的问题

## 3.1 超卖问题

分析秒杀的业务场景，最重要的一点就是超卖问题。假如备货只有 100件，但是最终卖了 200 件，一般来讲秒杀系统的价格都比较低，如果超卖将严重影响公司的财产利益，因此首当其冲的就是解决超卖的问题。

## 3.2 高并发

秒杀具有时间短、并发量大的特点，秒杀持续的时间只有几秒到几分钟。因为商品的价格极低，就会有很多用户参与抢购。在极端的时间内，同时有几万到几十万的请求同时进来，后端如何防止高并发造成的缓存击穿或者失效，击垮数据库都是需要考虑的问题。

## 3.3 接口防刷

现在的秒杀系统大多数都会出来针对秒杀的对应软件，这类软件会模拟不断向后台服务器发送请求，一秒几百次都是很常见的，如何防止这类软件的重复无效请求，防止不断发起的请求也是需要我们针对性的考虑的。

## 3.4 秒杀 URL

稍微有技术功底的用户，可以通过查看秒杀的 url，通过特定软件去请求也可以实现秒杀。或者提前知道秒杀的 URL 的人，一请求就直接实现了秒杀了。

## 3.5 数据库设计

秒杀有把我们服务器击垮的风险，如果让它与我们的其他业务使用在同一个数据库中，耦合在一起，就很有可能牵连和影响其他的业务。如何防止这类问题发生，就算秒杀发生了宕机、服务器卡死问题，也应该让他尽量不影响线上正常进行的业务。

## 3.6 大量请求问题

如何承载这样巨大的访问量，同时提供稳定低时延的服务保证，是需要面对的一大挑战，如果使用的是 Redis 缓存，单台 Redis 服务器可承受的 QPS 大概是 4W 左右，如果一个秒杀吸引的用户量足够多的话，单 QPS 可能达到几十万，单体 Redis 还是不足以支撑如此巨大的请求量。缓存会被击穿，直接渗透到 DB，从而击垮 MySQL。




***
## 4 设计与编码概览

## 设计思路
### 秒杀的业务场景
核心是瞬时的请求过多，程序的性能处理不过来，导致相关的异常和错误


### 解决思路
解决的思路有两个：

- 一：减少瞬时的请求
- 二：增强程序的处理性能

#### 减少瞬时的请求
这个可以在前后端都做工作

- 前端：
- 将静态资源之类的都缓存到CDN之类的，请求这些就不用访问处理业务的服务器，这样就减少了一部分的请求
- 在秒杀点击的时候，加一些答题或者验证码之类的按钮，这样能增加请求的发送延时，也就是将请求的分布时间区间增加，这样也能减少瞬时请求

- 后端：
- 通过集群负载均衡，将请求进行平均，这样也减少每个服务器的瞬时请求
- 使用消息队列之类的技术，将请求先放到队列中，服务器再进行获取和处理，服务器按照自己的处理性能进行获取，这样也是减少瞬时的请求
- 分层过滤：将一些不合规的请求，比如机器人刷单之类的请求给过滤掉，这样到达服务器的请求也能减少了

#### 增强处理性能

- 降级：将其他不必要的服务进行降级，将资源给秒杀核心服务，这样能增强处理性能
- 缓存：将某些放入缓存中进行读写操作，避免访问数据库之类的，速度快了，也是增强处理性能


